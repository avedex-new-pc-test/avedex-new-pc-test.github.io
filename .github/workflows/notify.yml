name: GitHub Pages Deployment Notification

on:
  # ç›‘å¬ GitHub Pages æ„å»ºå®Œæˆäº‹ä»¶
  page_build:
  # ç›‘å¬å·¥ä½œæµå®Œæˆäº‹ä»¶
  workflow_run:
    workflows: ["pages-build-deployment"]
    types: [completed]

jobs:
  notify-deployment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Get latest commit info
      id: commit-info
      run: |
        # è®¾ç½®å­—ç¬¦ç¼–ç ä¸º UTF-8
        export LANG=C.UTF-8
        export LC_ALL=C.UTF-8
        
        # è·å–æœ€æ–°æäº¤ä¿¡æ¯
        COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" | tr '\n' ' ')
        AUTHOR_NAME=$(git log -1 --pretty=format:"%an")
        COMMIT_SHA=$(git rev-parse --short HEAD)
        
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
    
    - name: Send deployment notification
      run: |
        # è®¾ç½®å­—ç¬¦ç¼–ç ä¸º UTF-8
        export LANG=C.UTF-8
        export LC_ALL=C.UTF-8
        
        # é…ç½®é£ä¹¦ webhook URLsï¼ˆæ”¯æŒå¤šä¸ªç¾¤ç»„ï¼‰
        WEBHOOK_URLS_STRING="https://open.larksuite.com/open-apis/bot/v2/hook/80e464ed-f005-434b-96aa-73af328eda6b,https://open.feishu.cn/open-apis/bot/v2/hook/146376ad-ea57-4a7e-b723-17edcc9df1dc"
        # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
        IFS=',' read -r -a FEISHU_WEBHOOK_URLS <<< "$WEBHOOK_URLS_STRING"
        
        # è·å–éƒ¨ç½²ä¿¡æ¯
        DEPLOYMENT_URL="https://avedex-new-pc-test.github.io"
        TIMESTAMP=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S CST")
        
        # è·å–æäº¤ä¿¡æ¯
        COMMIT_MESSAGE="${{ steps.commit-info.outputs.commit_message }}"
        AUTHOR_NAME="${{ steps.commit-info.outputs.author_name }}"
        
        # å‘é€é€šçŸ¥çš„å‡½æ•°
        send_notification() {
          local message="$1"
          echo "ğŸ“¤ å‘é€é€šçŸ¥åˆ° ${#FEISHU_WEBHOOK_URLS[@]} ä¸ªé£ä¹¦ç¾¤ç»„..."
          
          for webhook_url in "${FEISHU_WEBHOOK_URLS[@]}"; do
            echo "ğŸ“¬ å‘é€åˆ°: $webhook_url"
            response=$(curl -X POST "$webhook_url" \
              -H "Content-Type: application/json; charset=utf-8" \
              -H "Accept: application/json" \
              -d "$message" \
              -w "%{http_code}" \
              -s)
            
            if [[ $response == *"200"* ]]; then
              echo "âœ… æˆåŠŸå‘é€åˆ°: $webhook_url"
            else
              echo "âŒ å‘é€å¤±è´¥åˆ°: $webhook_url (HTTP: $response)"
            fi
          done
        }
        
        # åˆ¤æ–­äº‹ä»¶ç±»å‹å’ŒçŠ¶æ€ï¼Œé¿å…é‡å¤é€šçŸ¥
        if [ "${{ github.event_name }}" = "page_build" ]; then
          # page_build äº‹ä»¶è¡¨ç¤ºæ„å»ºå®Œæˆ
          echo "âœ… GitHub Pages æ„å»ºå®Œæˆï¼Œå‘é€éƒ¨ç½²æˆåŠŸé€šçŸ¥åˆ°é£ä¹¦..."
          SUCCESS_MESSAGE="{
            \"msg_type\": \"text\",
            \"content\": {
              \"text\": \"ğŸ‰ Ave.ai æµ‹è¯•ç¯å¢ƒ GitHub Pages éƒ¨ç½²æˆåŠŸï¼\\n\\nğŸ“¦ é¡¹ç›®: avedex-new-pc-test\\nğŸŒ¿ åˆ†æ”¯: main\\nğŸ‘¤ ä½œè€…: $AUTHOR_NAME\\nğŸ’¬ æäº¤: $COMMIT_MESSAGE\\nğŸ”— è®¿é—®åœ°å€: $DEPLOYMENT_URL\\nâœ… å®Œæˆæ—¶é—´: $TIMESTAMP\\n\\nğŸ‘† ç‚¹å‡»é“¾æ¥æŸ¥çœ‹æœ€æ–°éƒ¨ç½²\"
            }
          }"
          send_notification "$SUCCESS_MESSAGE"
            
        elif [ "${{ github.event_name }}" = "workflow_run" ]; then
          # workflow_run äº‹ä»¶ï¼Œåªåœ¨å¤±è´¥æ—¶é€šçŸ¥
          if [ "${{ github.event.workflow_run.conclusion }}" = "failure" ]; then
            echo "âŒ GitHub Pages éƒ¨ç½²å¤±è´¥ï¼Œå‘é€å¤±è´¥é€šçŸ¥åˆ°é£ä¹¦..."
            FAILURE_MESSAGE="{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"ğŸ’¥ Ave.ai æµ‹è¯•ç¯å¢ƒ GitHub Pages éƒ¨ç½²å¤±è´¥ï¼\\n\\nğŸ“¦ é¡¹ç›®: avedex-new-pc-test\\nğŸŒ¿ åˆ†æ”¯: main\\nğŸ‘¤ ä½œè€…: $AUTHOR_NAME\\nğŸ’¬ æäº¤: $COMMIT_MESSAGE\\nâŒ å¤±è´¥æ—¶é—´: $TIMESTAMP\\n\\nè¯·æ£€æŸ¥: https://github.com/avedex-new-pc-test/avedex-new-pc-test.github.io/actions\"
              }
            }"
            send_notification "$FAILURE_MESSAGE"
          else
            echo "â„¹ï¸  workflow_run äº‹ä»¶æˆåŠŸï¼Œä½†å·²é€šè¿‡ page_build äº‹ä»¶é€šçŸ¥ï¼Œè·³è¿‡é‡å¤é€šçŸ¥"
          fi
        fi