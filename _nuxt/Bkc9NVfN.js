import{f as e,B as a,aa as s,b5 as t,ad as l,b6 as i,ao as n,D as o,x as r,s as u,Y as d,ck as c,ab as m,c9 as p,b1 as v,bf as f,ac as b,g as _,n as h,aY as g,y as x,l5 as k,b4 as y,R as w,ae as N,j,c as A,o as F,a as S,b as $,i as T,J as C,w as I,d as E,t as R,at as V,l as z,F as P,r as B,e as L,a1 as M,k as U,X as O,K as W,a9 as D,L as H,O as J,aC as K,b$ as X,aZ as Y,ai as G,b8 as Q,b9 as Z,ba as q,bc as ee,bd as ae,be as se}from"./B65fceU8.js";import{_ as te}from"./B2Gqj98b.js";import{E as le}from"./C7T7CFu_.js";import{u as ie,_ as ne}from"./CnDKkNIY.js";import{u as oe}from"./UpwjFHMu.js";import"./CzOUaPrr.js";import"./WwFlK4Sr.js";import"./CeKo4sM-.js";import"./CkPGQFuL.js";import"./DlTfGBrO.js";import"./CbxefQZI.js";import"./z77-U_wr.js";import"./wh_d0fk5.js";import"./CMsCuTMf.js";import"./CTBUSF_Q.js";import"./BrvvCKFg.js";import"./2GY3xYIz.js";import"./9bZM2T3M.js";import"./wUUvUfao.js";const re={class:"flex justify-between items-center mt-10px pr-15px"},ue=["infinite-scroll-disabled"],de={class:"pr-10px pb-20px"},ce={class:"flex-[1.5] flex items-center"},me={class:"ml-6px"},pe={class:"flex"},ve={class:"color-[var(--d-F5F5F5-l-333)]"},fe={class:"mt-2px color-[var(--d-999-l-666)]"},be={class:"flex-1 flex flex-col items-end"},_e={class:"flex-1 flex justify-end"},he={key:1,class:"color-[var(--d-EAECEF-l-333)]"},ge={key:0,class:"color-#959a9f text-12px text-center"},xe=e({__name:"positionsTable",props:{height:{type:[Number,String],default:370}},setup(e){const{t:xe}=a(),ke=s(),ye=t(),we=l(),Ne=oe(),je=ie(),Ae=i(),{hide_risk:Fe,hide_small:Se}=n(o());r(()=>ke.wsResult[m.PRICEV2],e=>{const a={};e.prices.forEach(e=>{a[e.token+"-"+e.chain]=e}),De.value=De.value.map(e=>{const s=a[e.index];if(s&&s.uprice>0){const a="--"===e.total_profit||0===Number(e.total_profit),t=new d(e.balance||0).times(s.uprice||0);if(a)return{...e,current_price_usd:s.uprice,balance_usd:t.toNumber()};{const a=new d(e.balance_usd||0).minus(e.total_profit||0),l=t.minus(a),i=new d(s.uprice||0).minus(e.average_purchase_price_usd||0).div(e.average_purchase_price_usd);return i.toNumber()<-1||Number(e.average_purchase_price_usd)<0?e:{...e,current_price_usd:s.uprice,balance_usd:t.toNumber(),total_profit:l.toFixed(),total_profit_ratio:i.toFixed()}}}return e}),c(De)}),r(()=>ke.wsResult[m.ASSET],e=>{var a,s;if(e.swap){const s="So11111111111111111111111111111111111111112"===e.swap.token||e.swap.token===p?p:e.swap.token,t=e.swap.chain,l=e.swap.type;if(s&&t){const i=De.value.findIndex(e=>e.token===s&&e.chain===t),n="0"===l,o="0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"===s,r=null==(a=De.value[i])?void 0:a.balance;i>-1&&(n?o?$e(s,t):(De.value[i].balance=Number(r)+Number(e.swap.amount),c(De)):o?$e(s,t):Number(r)===Number(e.swap.amount)?(De.value.splice(i,1),c(De)):(De.value[i].balance=Number(r)-Number(e.swap.amount),c(De)))}}else if(e.transfer){const a=e.transfer.chain,t=e.transfer.token,l=e.transfer.type;if(t&&a){const i=De.value.findIndex(e=>e.token===t&&e.chain===a),n="0"===l;if(i>-1){const a=De.value[i],t=Number(a.balance),l=a.current_price_usd,o=new d(t).plus(n?e.transfer.amount:-(null==(s=e.transfer)?void 0:s.amount)),r=o.multipliedBy(l);a.balance=o.toString(),a.balance_usd=r.toNumber(),c(De)}}}});const $e=v(function(e,a){const s=we.getWalletAddress(a);s&&f({chain:a,walletAddress:s,tokens:[e]}).then(s=>{De.value=De.value.map(t=>t.token===e&&t.chain===a?{...t,balance:s[0].balance,balance_usd:new d(s[0].balance||0).times(t.current_price_usd||0).toNumber()}:{...t})})},1e3,!1,!0);function Te(){We.value.pageNo=1,We.value.finished=!1}const Ce=b(),Ie=_(()=>we.userInfo?we.userInfo.addresses.map(({address:e,chain:a})=>e+"-"+a):Ce.address?[Ce.address+"-"+Ce.chain]:[]);r(()=>Ie.value,()=>{Ee.value.user_ids=Ie.value});const Ee=h({hide_risk:Fe,hide_small:Se,user_ids:Ie.value}),Re=h({}),Ve=e,ze=_(()=>Number(Ve.height)-110),Pe=g("scrollContainerRef"),Be=Y(()=>{const{value:e}=Pe;e&&e.scrollHeight<=e.clientHeight&&!We.value.finished&&He()},200);r(ze,Be);const Le=u({sortBy:void 0,activeSort:0}),Me={"-1":"asc",1:"desc"},Ue=_(()=>({sort_dir:Me[Le.value.activeSort],sort:Le.value.sortBy})),Oe=_(()=>[{label:`${xe("token")}/${xe("balance1")}`,value:"balance_usd",flex:"flex-[1.5]",sort:!0},{label:xe("profit2"),value:"total_profit",flex:"flex-1 justify-end",sort:!0},{label:"",value:"",flex:"flex-1 justify-end",sort:!1}]),We=u({finished:!1,loading:!1,pageNo:1,pageSize:10}),De=u([]);async function He(){try{We.value.loading=!0;const e=We.value.pageNo,a=await k({pageNO:We.value.pageNo,pageSize:We.value.pageSize,...Ee.value,...Ue.value});if(Array.isArray(null==a?void 0:a.data)&&a.data.length>0){if(1===e)De.value=a.data.map(e=>{var a;return{...e,index:e.token===p?(null==(a=y(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}});else{const e=a.data.filter(e=>De.value.every(a=>a.index!==`${e.token}-${e.chain}`)).map(e=>{var a;return{...e,index:e.token===p?(null==(a=y(e.chain))?void 0:a.wmain_wrapper)+"-"+e.chain:`${e.token}-${e.chain}`}});De.value=De.value.concat(e)}We.value.finished=a.data.length<We.value.pageSize,We.value.finished||We.value.pageNo++}else 1===We.value.pageNo&&(De.value=[]);je.setMultiPriceParams("positions",De.value.map(e=>e.token+"-"+e.chain)),je.sendPriceWs()}catch(e){}finally{We.value.loading=!1,c(We)}}async function Je(e){if(!G())return;if(!e.token)return;const a=we.getWalletAddress(e.chain);if(a)try{Re.value[e.index]=!0;const s=(await f({chain:e.chain,tokens:[e.token],walletAddress:a}))[0];s&&(e.balance=s.balance||0,e.balance_usd=new d(s.balance||0).times(e.current_price_usd||0).toNumber(),e.decimals=s.decimals||e.decimals);const t=s.balance||0;if(!t)return void Q({title:"Error",type:"error",message:s("insufficientBalance")});await Ne.checkApproveAndApprove({chain:e.chain,token:e.token,owner:a}),function(e,a){var s;if(!G())return;if(new d(e||0).lte(0))return void Q({title:"Error",type:"error",message:xe("amountMustG0")});const t=null==(s=new d(e||0).toFixed().match(new RegExp(`[0-9]*(\\.[0-9]{0,${a.decimals||18}})?`)))?void 0:s[0];if((Number(t)||0)<=0)return void Q({title:"Error",type:"error",message:xe("amountTooSmall")});Re.value[a.index]=!0,async function(e,a){var s,t,l;const i="solana"===a.chain,{botSettings:n}=ye,o=null==(s=null==n?void 0:n[a.chain])?void 0:s.selected,u=null==(t=null==n?void 0:n[a.chain])?void 0:t[o];if(i&&(null==u?void 0:u.mev)&&!(await we.getBundleAvailable()))return void(Re.value[a.index]=!1);const{gasTip1List:c,gasTip2List:m}=Z(q().gasTip,"solana"),v=(null==u?void 0:u.mev)?c:m,f=(null==u?void 0:u.mev)?null==u?void 0:u.gas[0]:null==(l=null==u?void 0:u.gas)?void 0:l[1];let b={};if(i){let e=(null==f?void 0:f.customFee)||(null==v?void 0:v[null==f?void 0:f.level])||"0.002";(null==u?void 0:u.mev)&&new d(e).lt("0.002")&&(e="0.002"),b.priorityFee=new d(e).times(10**9).toFixed(0)}else{const e=0===Number(null==f?void 0:f.customFee)?"0":(null==f?void 0:f.customFee)||(null==v?void 0:v[null==f?void 0:f.level])||"3";b.gasTip=Number(new d(e).times(10**9).toFixed(0)),b.contractType=0,b.chain=a.chain}const _={solana:"sol",ton:"TON"}[a.chain]||p,h=(null==u?void 0:u.slippage)||"9",g=we.getWalletAddress(a.chain);if(!g)return;b={...b,batchId:Date.now().toString(),swapList:[{creatorAddress:g,inAmount:new d(e||0).times(10**a.decimals||0).toFixed(0)}],inTokenAddress:a.token,outTokenAddress:_,swapType:2,isPrivate:(null==u?void 0:u.mev)||!1,slippage:"auto"!==h?Number(new d(h).times(100).toFixed(0)):900};(i?ee(b):ae(b)).then(e=>function(e,a,s){if(e){let e=setTimeout(()=>{Q({type:"success",message:xe("transactionsSubmitted")}),Ae.placeOrderUpdate++,Re.value[s]=!1},500);const t=r(()=>ke.wsResult.tgbot,l=>{var i,n,o,r;l.batchId===a&&(e&&(clearTimeout(e),e=null),Ae.placeOrderSuccess++,(null==(n=null==(i=null==l?void 0:l.txList)?void 0:i[0])?void 0:n.success)?(Q({type:"success",message:xe("tradeSuccess")}),t()):(se((null==(r=null==(o=null==l?void 0:l.txList)?void 0:o[0])?void 0:r.failMessage)||"swap error"),t()),Re.value[s]=!1)})}}(e,b.batchId,a.index)).catch(e=>{se(e||"swap error"),Re.value[a.index]=!1})}(e,a)}(t,e)}finally{Re.value[e.index]=!1}}return x(()=>{He()}),r(()=>[Ue.value,Ee.value.hide_risk,Ee.value.hide_small,we.evmAddress,()=>Ce.address,()=>Ce.walletSignature[Ce.address]],()=>{Te(),He()}),(e,a)=>{const s=V,t=te,l=M,i=U,n=H,o=L,r=K,u=le,d=X,c=N;return w((F(),A("div",null,[S("div",re,[$(s,{modelValue:j(Ee).hide_risk,"onUpdate:modelValue":a[0]||(a[0]=e=>j(Ee).hide_risk=e),class:"ml-12px",style:{marginRight:0},size:"small","true-value":1,"false-value":0},{default:I(()=>[E(R(e.$t("hideRiskTokenShort")),1)]),_:1},8,["modelValue"]),$(s,{modelValue:j(Ee).hide_small,"onUpdate:modelValue":a[1]||(a[1]=e=>j(Ee).hide_small=e),size:"small","true-value":1,"false-value":0},{default:I(()=>[E(R(e.$t("hideSmallAssets1")+"<1USD"),1)]),_:1},8,["modelValue"]),j(we).evmAddress?(F(),T(t,{key:0,userIds:j(Ee).user_ids,"onUpdate:userIds":[a[2]||(a[2]=e=>j(Ee).user_ids=e),a[3]||(a[3]=e=>{Te(),He()})]},null,8,["userIds"])):C("",!0)]),$(ne,{sort:j(Le),"onUpdate:sort":a[4]||(a[4]=e=>z(Le)?Le.value=e:null),columns:j(Oe)},null,8,["sort","columns"]),$(u,{height:j(ze)},{default:I(()=>[w((F(),A("div",{ref_key:"scrollContainerRef",ref:Pe,"infinite-scroll-disabled":j(We).finished||j(We).loading,"infinite-scroll-distance":"200","infinite-scroll-delay":10,"infinite-scroll-immediate":!1},[S("div",de,[(F(!0),A(P,null,B(j(De),(a,s)=>(F(),T(o,{key:s,class:"text-12px flex justify-between pl-10px py-10px cursor-pointer hover:bg-[var(--d-1A1A1A-l-F2F2F2)]",to:`/token/${a.index}`},{default:I(()=>[S("div",ce,[$(l,{row:a},null,8,["row"]),S("div",me,[S("div",pe,[S("span",ve,R(a.symbol),1),a.risk_score>55||a.risk_level<0?(F(),T(i,{key:0,name:"custom:danger",class:"font-14 ml-2px color-#F72121"})):C("",!0)]),S("div",fe,[0===a.balance?(F(),A(P,{key:0},[E("$0")],64)):"--"===a.balance?(F(),A(P,{key:1},[E("--")],64)):(F(),A(P,{key:2},[E(R(("formatNumber"in e?e.formatNumber:j(O))(a.balance,2))+"("+R("$"+("formatNumber"in e?e.formatNumber:j(O))(a.balance_usd||0,2))+") ",1)],64))])])]),S("div",be,[S("div",{class:W(("getColorClass"in e?e.getColorClass:j(D))(a.total_profit))},[0===Number(a.total_profit)?(F(),A(P,{key:0},[E("0")],64)):"--"===a.total_profit?(F(),A(P,{key:1},[E("--")],64)):(F(),A(P,{key:2},[E(R(Number(a.total_profit)>0?"$":"-$")+R(("formatNumber"in e?e.formatNumber:j(O))(Math.abs(Number(a.total_profit)),2)),1)],64))],2),S("div",{class:W(("getColorClass"in e?e.getColorClass:j(D))(a.total_profit_ratio))},[0===Number(a.total_profit_ratio)?(F(),A(P,{key:0},[E("0")],64)):"--"===a.total_profit_ratio?(F(),A(P,{key:1},[E("--")],64)):(F(),A(P,{key:2},[E(R(Number(a.total_profit_ratio)>0?"+":"-")+R(("formatNumber"in e?e.formatNumber:j(O))(Math.abs(100*Number(a.total_profit_ratio)),2))+"% ",1)],64))],2)]),S("div",_e,[j(we).evmAddress&&"0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"!==a.token?(F(),T(n,{key:0,size:"small",loading:j(Re)[a.index],class:"[--el-border:0] [&&]:[--el-button-bg-color:--d-222-l-F2F2F2] [&&]:font-normal",style:{padding:"4px"},onClick:J(e=>Je(a),["stop","prevent"])},{default:I(()=>[E(R(e.$t("closePosition")),1)]),_:2},1032,["loading","onClick"])):(F(),A("span",he,"--"))])]),_:2},1032,["to"]))),128)),0!==j(De).length||j(We).loading?C("",!0):(F(),T(r,{key:0}))]),j(We).loading&&1!==j(We).pageNo?(F(),A("div",ge,R(e.$t("loading")),1)):C("",!0)],8,ue)),[[d,He]])]),_:1},8,["height"])])),[[c,j(We).loading&&1===j(We).pageNo]])}}});export{xe as default};
